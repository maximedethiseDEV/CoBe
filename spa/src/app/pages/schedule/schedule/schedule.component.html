<header
    class="sticky top-0 z-10 flex items-center justify-between bg-white/90 backdrop-blur-xl border-b border-gray-200 shadow-sm px-6 py-2">
    <h1 class="flex items-center gap-2 text-xl font-bold text-indigo-600">
        <i-lucide [img]="iconHeader" class="w-6 h-6"></i-lucide>
        {{ labelHeader }}
    </h1>

    <div class="flex items-center gap-2">

        <!--
        <button
            (click)="updateEntity(selectedEntity!)"
            [disabled]="!hasSelection()"
            class="px-4 py-2 bg-blue-50 border border-blue-200 text-blue-700 font-medium rounded-lg hover:bg-blue-100 hover:text-blue-800 disabled:opacity-50 disabled:cursor-not-allowed"
            title="Modifier (E)"
        >
            <i-lucide [img]="updateIcon"></i-lucide>
        </button>
-->
        <button
            (click)="sendEntity(selectedEntity!)"
            [disabled]="!hasSelection()"
            class="px-4 py-2 bg-green-50 border border-green-200 font-medium rounded-lg hover:border-green-200 disabled:opacity-50 disabled:cursor-not-allowed"
            title="Envoyer au transporteur">
            <i-lucide [img]="sendIcon"></i-lucide>
        </button>

        <button
            (click)="refreshData()
"
            class="px-3 py-2 bg-gray-100 border border-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-200 hover:text-indigo-600 transition-colors duration-200"
            title="Actualiser">
            <i-lucide [img]="refreshIcon"></i-lucide>
        </button>
    </div>
</header>

<main class="flex-1 overflow-y-auto">
    <div class="grid grid-cols-8 gap-4 p-4">
        <section class="col-span-7">
            <div class="bg-white border rounded shadow-sm overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 sticky top-0">
                    <tr class="border-b border-gray-200">
                        @for (column of tableColumns; track column.key) {
                            <th class="px-4 py-2 text-center">
                                <button
                                    class="mx-auto flex items-center justify-center gap-2 hover:text-indigo-600"
                                    (click)="toggleSort(column)"
                                    [disabled]="!column.sort"
                                    [class.opacity-50]="!column.sort"
                                    title="Cliquer pour trier">
                                    <span>{{ column.translate }}</span>
                                    @if (sortKey !== column.key || !sortDir) {
                                        <span class="text-gray-400"><i-lucide [img]="filterIcon"></i-lucide></span>
                                    } @else if (sortKey === column.key && sortDir === 'asc') {
                                        <i-lucide [img]="sortAscIcon"></i-lucide>
                                    } @else {
                                        <i-lucide [img]="sortDescIcon"></i-lucide>
                                    }
                                </button>

                                <div class="mt-2">
                                    @switch (column.type) {
                                        @case ('text') {
                                            <input
                                                type="text"
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                [value]="filters[column.key]"
                                                (input)="filters[column.key] = ($any($event.target).value); onFilterChange()"
                                                placeholder="Filtrer..."/>
                                        }
                                        @case ('uuid') {
                                            <input
                                                type="text"
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                [value]="filters[column.key]"
                                                (input)="filters[column.key] = ($any($event.target).value); onFilterChange()"
                                                placeholder="Filtrer..."/>
                                        }
                                        @case ('number') {
                                            <input
                                                type="number"
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                [value]="filters[column.key]"
                                                (input)="filters[column.key] = ($any($event.target).value); onFilterChange()"
                                                placeholder="= nombre"/>
                                        }
                                        @case ('date') {
                                            <input
                                                type="date"
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                [value]="filters[column.key]"
                                                (input)="filters[column.key] = ($any($event.target).value); onFilterChange()"/>
                                        }
                                        @case ('boolean') {
                                            <select
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                [value]="filters[column.key]"
                                                (change)="filters[column.key] = ($any($event.target).value); onFilterChange()">
                                                <option value="">Tous</option>
                                                <option value="true">Oui</option>
                                                <option value="false">Non</option>
                                            </select>
                                        }
                                        @default {
                                            <input
                                                type="text"
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                [value]="filters[column.key]"
                                                (input)="filters[column.key] = ($any($event.target).value); onFilterChange()"
                                                placeholder="Filtrer..."/>
                                        }
                                    }
                                </div>
                            </th>
                        }
                    </tr>
                    </thead>

                    <tbody>
                        @if (filteredData.length === 0) {
                            <tr>
                                <td [attr.colspan]="tableColumns.length" class="px-4 py-12 text-center">
                                    <div class="flex flex-col items-center space-y-3">
                                        <div
                                            class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                                            <i-lucide [img]="emptyDataIcon" class="w-6 h-6 text-indigo-600"></i-lucide>
                                        </div>
                                        <div class="text-gray-500 text-sm">Aucune donnée disponible</div>
                                    </div>
                                </td>
                            </tr>
                        }

                        @for (d of paginatedData; track d.id) {
                            <tr
                                (click)="selectRow(d)"
                                draggable="true"
                                (dragstart)="onDragStart($event, d.id)"
                                class="cursor-pointer odd:bg-white even:bg-gray-50 hover:bg-indigo-50 transition-colors"
                                [class.ring-1]="selectedEntity?.id === d.id"
                                [class.ring-indigo-200]="selectedEntity?.id === d.id">
                                @for (column of tableColumns; track column.key) {
                                    <td
                                        class="px-4 py-2 text-center"
                                        [class.bg-indigo-600]="selectedEntity?.id === d.id"
                                        [class.text-white]="selectedEntity?.id === d.id">
                                        @if (column.key === 'orderId') {
                                            <div class="flex items-center gap-2 justify-center">
                                                <span
                                                    class="inline-block w-2 h-2 rounded-full bg-indigo-400 animate-pulse"
                                                    draggable="false"></span>
                                                {{ getColumnValue(d, column) }}
                                            </div>
                                        } @else {
                                            {{ getColumnValue(d, column) }}
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>

                @if (totalPages > 1) {
                    <footer
                        class="sticky bottom-0 flex bg-gray-50 px-6 py-3 items-center justify-between border-t border-gray-200">
                        <div class="text-sm text-gray-600">
                            <span class="text-indigo-600 font-semibold">{{ startIndex + 1 }}</span> –
                            <span class="text-indigo-600 font-semibold">{{ endIndex }}</span>
                            sur <span class="text-gray-800 font-semibold">{{ totalElements }}</span>
                        </div>

                        <div class="flex items-center gap-1">
                            <button
                                (click)="goToPage(currentPage - 1)"
                                [disabled]="currentPage === 1"
                                class="px-3 py-1 text-sm text-gray-600 bg-white border border-gray-200 rounded-md hover:bg-gray-50 disabled:opacity-50">
                                <i-lucide [img]="previousPageIcon" class="w-4 h-4"></i-lucide>
                            </button>

                            <div class="flex">
                                @for (page of getVisiblePages(); track page) {
                                    <button
                                        (click)="goToPage(page)"
                                        class="px-3 py-1 text-sm rounded-md"
                                        [class]="page === currentPage ? 'bg-indigo-600 text-white' : 'text-gray-700 bg-white border border-gray-200 hover:bg-gray-50'">
                                        {{ page }}
                                    </button>
                                }
                            </div>

                            <button
                                (click)="goToPage(currentPage + 1)"
                                [disabled]="currentPage === totalPages"
                                class="px-3 py-1 text-sm text-gray-600 bg-white border border-gray-200 rounded-md hover:bg-gray-50 disabled:opacity-50">
                                <i-lucide [img]="nextPageIcon" class="w-4 h-4"></i-lucide>
                            </button>
                        </div>
                    </footer>
                }
            </div>
        </section>

        <aside class="col-span-1">
            <div class="bg-white border rounded shadow-sm overflow-hidden flex flex-col h-full">
                <div class="bg-gray-50 px-3 py-2 border-b text-sm font-medium">Transporteurs</div>
                <div class="p-2 border-b">
                    <input
                        class="w-full px-2 py-1 text-xs border rounded"
                        placeholder="Rechercher par nom"
                        [value]="transporterFilter"
                        (input)="transporterFilter = ($any($event.target).value)"/>
                </div>
                <div class="flex-1 overflow-y-auto divide-y">
                    @for (t of filteredTransporters; track t.id) {
                        <div class="p-3 hover:bg-gray-50 transition-colors">
                            <div class="font-semibold text-gray-800">{{ t.name }}</div>
                            <div class="mt-2 border rounded p-2 min-h-12 bg-gray-50/30"
                                 (dragover)="allowDrop($event)" (drop)="onDrop($event, t.id)">
                                <div class="flex flex-col gap-1">
                                    @for (a of getAssignments(t.id); track a.id) {
                                        <span class="text-xs text-gray-700 truncate">• {{ deliveryLabel(a) }}</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </aside>
    </div>
</main>
