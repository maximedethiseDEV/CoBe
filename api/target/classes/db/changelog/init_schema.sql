CREATE TABLE "country"
(
    "country_id"   INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "country_code" VARCHAR(3) UNIQUE NOT NULL,
    "country_name" VARCHAR(255)      NOT NULL
);
CREATE TABLE "city"
(
    "city_id"     INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "postal_code" VARCHAR(6) UNIQUE NOT NULL,
    "city_name"   VARCHAR(255)      NOT NULL,
    "country_id"  INTEGER           NOT NULL REFERENCES "country" ("country_id") ON DELETE RESTRICT
);

CREATE INDEX "idx_city_name" ON "city" ("city_name");

CREATE TABLE "address"
(
    "address_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "city_id"    INTEGER      NOT NULL REFERENCES "city" ("city_id") ON DELETE RESTRICT,
    "street"     VARCHAR(255) NOT NULL
);


CREATE TABLE "shared_details"
(
    "shared_details_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "attachment_path"   VARCHAR(255),
    "notes"             TEXT
);

CREATE TABLE delivery_status
(
    status_id SERIAL PRIMARY KEY,
    status    VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE "contact"
(
    "contact_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "last_name"  VARCHAR(255) NOT NULL,
    "first_name" VARCHAR(255),
    "phone"      VARCHAR(255),
    "email"      VARCHAR(255),
    "role"       VARCHAR(50)
);


CREATE TABLE "dbuser"
(
    "user_id"       INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "username"      VARCHAR(255) NOT NULL UNIQUE,
    "password_hash" VARCHAR(255) NOT NULL,
    "contact_id"    INTEGER      REFERENCES "contact" ("contact_id") ON DELETE SET NULL,
    "permission"    VARCHAR(50)
);


CREATE TABLE "company"
(
    "company_id"          INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name"                VARCHAR(255) NOT NULL,
    "commercially_active" BOOLEAN      NOT NULL,
    "primary_contact_id"  INTEGER      REFERENCES "contact" ("contact_id") ON DELETE SET NULL,
    "address_id"          INTEGER      REFERENCES "address" ("address_id") ON DELETE SET NULL,
    "shared_details_id"   INTEGER      REFERENCES "shared_details" ("shared_details_id") ON DELETE SET NULL
);

CREATE INDEX "idx_company_name_active" ON "company" ("name" ASC) WHERE "commercially_active" = TRUE;


CREATE TABLE "transport_supplier"
(
    "transport_supplier_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "company_id"            INTEGER NOT NULL REFERENCES "company" ("company_id") ON DELETE CASCADE,
    "license_number"        VARCHAR(255)
);

CREATE TABLE "material_supplier"
(
    "material_supplier_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "company_id"           INTEGER NOT NULL REFERENCES "company" ("company_id") ON DELETE CASCADE,
    "contact_id"           INTEGER REFERENCES "contact" ("contact_id") ON DELETE SET NULL,
    "loading_address_id"   INTEGER REFERENCES "address" ("address_id") ON DELETE SET NULL,
    "notes"                TEXT
);

CREATE TABLE customer
(
    customer_id         INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    company_id          INTEGER NOT NULL REFERENCES company (company_id) ON DELETE CASCADE,
    contact_id          INTEGER REFERENCES contact (contact_id) ON DELETE SET NULL,
    delivery_address_id INTEGER REFERENCES address (address_id) ON DELETE SET NULL,
    attachment_path     VARCHAR(255),
    notes               TEXT,
    date_start          DATE,
    date_end            DATE,
    is_solvent          BOOLEAN NOT NULL,
    parent_id           INTEGER REFERENCES customer (customer_id) ON DELETE SET NULL
);


CREATE TABLE "construction_site"
(
    "construction_site_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "customer_id"          INTEGER REFERENCES customer ("customer_id") ON DELETE CASCADE,
    "address_id"           INTEGER NOT NULL REFERENCES "address" ("address_id") ON DELETE RESTRICT,
    "shared_details_id"    INTEGER REFERENCES "shared_details" ("shared_details_id") ON DELETE SET NULL,
    "date_start"           DATE,
    "date_end"             DATE
);


CREATE TABLE "product"
(
    "product_id"           INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "name"                 VARCHAR(255) NOT NULL,
    "material_supplier_id" INTEGER      REFERENCES "material_supplier" ("material_supplier_id") ON DELETE SET NULL,
    "notes"                TEXT
);


CREATE TABLE "orders"
(
    "order_id"                INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "billing_customer_id"     INTEGER NOT NULL REFERENCES "customer" ("customer_id") ON DELETE RESTRICT,
    "delivery_customer_id"    INTEGER REFERENCES "customer" ("customer_id") ON DELETE SET NULL,
    "product_id"              INTEGER NOT NULL REFERENCES "product" ("product_id") ON DELETE RESTRICT,
    "quantity"                INTEGER NOT NULL,
    "requested_delivery_date" DATE,
    "requested_delivery_time" TIME,
    "shared_details_id"       INTEGER REFERENCES "shared_details" ("shared_details_id") ON DELETE SET NULL
);

CREATE TABLE "delivery_order_number"
(
    "delivery_order_number_id"     INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "transport_supplier_id"        INTEGER            NOT NULL REFERENCES "transport_supplier" ("transport_supplier_id") ON DELETE RESTRICT,
    "city_id"                      INTEGER            NOT NULL REFERENCES "city" ("city_id") ON DELETE RESTRICT,
    "product_id"                   INTEGER            NOT NULL REFERENCES "product" ("product_id") ON DELETE RESTRICT,
    "unique_delivery_order_number" VARCHAR(20) UNIQUE NOT NULL
);

CREATE TABLE "delivery"
(
    "delivery_id"              INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "order_id"                 INTEGER NOT NULL REFERENCES "orders" ("order_id") ON DELETE RESTRICT,
    "transport_supplier_id"    INTEGER NOT NULL REFERENCES "transport_supplier" ("transport_supplier_id") ON DELETE RESTRICT,
    "delivery_order_number_id" INTEGER NOT NULL REFERENCES "delivery_order_number" ("delivery_order_number_id") ON DELETE RESTRICT,
    "actual_delivery_date"     DATE,
    "actual_delivery_time"     TIME,
    "quantity"                 INTEGER NOT NULL,
    "status_id"                INTEGER NOT NULL REFERENCES "delivery_status" ("status_id")
);

CREATE TABLE "delivery_archive"
(
    "delivery_archive_id"      INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "order_id"                 INTEGER,
    "transport_supplier_id"    INTEGER,
    "delivery_order_number_id" INTEGER,
    "actual_delivery_date"     DATE,
    "actual_delivery_time"     TIME,
    "status_id"                INTEGER
);